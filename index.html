<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <title>クールシェアたからづか2025 抽選会</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="container"></div>
    <div id="roulette">
      <h2 class="txt">
        クールシェアたからづか2025<br />
        <span class="txt1">抽</span><span class="txt2">選</span
        ><span class="txt3">会</span>
      </h2>
      <h2 id="gift"></h2>
      <h2 id="people"></h2>
      <h2 id="val"></h2>
      <button id="start">スタート</button>
      <button id="finish">ストップ</button>

      <audio id="audio1" src="./ドラムロール.mp3"></audio>
      <audio id="audio2" src="./ロールの締め.mp3"></audio>
      <form
        id="userForm1"
        action="https://script.google.com/macros/s/AKfycbzmvpmPi0__Sc9gDHIWh0OskfzLZM1kdzw63BBTI9r87oD-ZHKysQD2FCF6Euz8FNJq/exec"
        method="post"
      >
        <input id="winner" type="hidden" name="winner" />
        <input id="winnerName" type="hidden" name="winnerName" />
        <button type="submit" style="display: none" ;></button>
      </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.3.2/dist/confetti.browser.min.js"></script>

    <script>
      let nameList = [];
      let gift = "";
      fetch(
        "https://docs.google.com/spreadsheets/d/1Z8sDgL_xPxY3t-8hC7KDcvmRnhrGpRay-OHKD8IIyBc/export?format=csv&gid=0"
      )
        .then((res) => res.text())
        .then((csvText) => {
          const parsedData = Papa.parse(csvText, { header: true });
          const dataArray = parsedData.data;

          // 例：name4列だけを取り出す
          nameList = dataArray.map((row) => row.name);
          console.log(nameList);
        })
        .catch((err) => console.error(err));

      fetch(
        "https://docs.google.com/spreadsheets/d/1Z8sDgL_xPxY3t-8hC7KDcvmRnhrGpRay-OHKD8IIyBc/export?format=csv&gid=0"
      )
        .then((response) => response.text())
        .then((csvText) => {
          const parsedData2 = Papa.parse(csvText, { header: true });
          const storeData = parsedData2.data;

          // A2セルの値（spot2列の1行目の値）を取得
          const gift = storeData[0]?.gift || "不明";
          document.getElementById("gift").textContent = gift;
        });

      fetch(
        "https://docs.google.com/spreadsheets/d/1Z8sDgL_xPxY3t-8hC7KDcvmRnhrGpRay-OHKD8IIyBc/export?format=csv&gid=0"
      )
        .then((response) => response.text())
        .then((csvText) => {
          const parsedData2 = Papa.parse(csvText, { header: true });
          const storeData = parsedData2.data;

          // A2セルの値（spot2列の1行目の値）を取得
          const people = storeData[0]?.people || "不明";
          document.getElementById("people").textContent = people;
        });

      function createConfetti() {
        confetti({
          angle: 90, // 紙吹雪が飛ぶ方向（指定しないと90＝上向き）90
          spread: 90,
          startVelocity: 60, // 紙吹雪が上に飛ぶ速度20
          scalar: 1.4, // 紙吹雪の大きさ2
          gravity: 1, // 重力 （0にすると紙吹雪が落ちない）1
          origin: {
            x: 0.5, // 紙吹雪の発生場所（両方とも0．5にすると中央）0.5
            y: 0.7,
          },
          particleCount: 50, //100
          ticks: 200, //1000
        });
      }

      const start = document.getElementById("start");
      const audio1 = document.getElementById("audio1");
      const audio2 = document.getElementById("audio2");
      console.log(start);
      start.addEventListener("click", function () {
        const roulette = setInterval(function () {
          const val = Math.floor(Math.random() * nameList.length);
          const nameVal = nameList[val] + "様";
          document.getElementById("val").textContent = nameVal;
          document.getElementById("winner").value = val;
          document.getElementById("winnerName").value = nameList[val];
          audio1.play();

          const finish = document.getElementById("finish");
          finish.addEventListener("click", function () {
            clearInterval(roulette);
            audio1.pause();
            audio2.play();
            createConfetti();
            document.getElementById("userForm1").submit();
          });
        }, 50);
      });
    </script>
  </body>
</html>
